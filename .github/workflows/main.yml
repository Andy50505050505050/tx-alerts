name: Transaction Alerts

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *' # Runs every 5 minutes

jobs:
  transaction_alerts:
    runs-on: ubuntu-latest
    steps:
      - name: Get transaction data from BscScan
        run: |
          # Set up environment variables directly
          API_KEY="0xA4b3445A58111ABD407C34402aB59B0FE05bFF5a"
          TOKEN_ADDRESS="0xAd52f33f9Fc4DE396f2e8236438e9c590680b54b"
          BOT_TOKEN="${{ secrets.TELEGRAMBOTTOKEN }}"
          CHAT_ID="-1002455751644"

          # Fetch the last transactions from the API
          RESPONSE=$(curl -s "https://api.bscscan.com/api?module=account&action=txlist&address=$TOKEN_ADDRESS&startblock=45459378&endblock=latest&sort=desc&apikey=$API_KEY")

          # Check if the API response is valid
          if echo "$RESPONSE" | jq -e .status > /dev/null 2>&1 && [ "$(echo "$RESPONSE" | jq -r .status)" = "1" ]; then
            # Iterate through the last 5 transactions
            for i in {0..4}
            do
              TX_HASH=$(echo "$RESPONSE" | jq -r ".result[$i].hash")
              TX_FROM=$(echo "$RESPONSE" | jq -r ".result[$i].from")
              TX_TO=$(echo "$RESPONSE" | jq -r ".result[$i].to")
              TX_VALUE=$(echo "$RESPONSE" | jq -r ".result[$i].value")
              TX_TIMESTAMP=$(echo "$RESPONSE" | jq -r ".result[$i].timeStamp")

              # Convert value from Wei to BNB, assuming the token follows standard Ethereum decimal places (18)
              TX_AMOUNT=$(bc <<< "scale=4; $TX_VALUE / 1000000000000000000")
              DATE_TIME=$(date -d @$TX_TIMESTAMP "+%Y-%m-%d %H:%M:%S")

              # Format the message
              MESSAGE="Transaction Alert:\n- Date & Time: $DATE_TIME\n- From: $TX_FROM\n- To: $TX_TO\n- Amount: $TX_AMOUNT BNB\n- Transaction Hash: $TX_HASH\n- Link: https://bscscan.com/tx/$TX_HASH\n\n"

              # Send the message to Telegram
              curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                -d "chat_id=$CHAT_ID" \
                -d "parse_mode=Markdown" \
                -d "text=$MESSAGE"
            done
          else
            echo "No valid transactions found or an error occurred: $RESPONSE"
