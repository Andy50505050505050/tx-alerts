name: Transaction Alerts

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *' # Runs every 5 minutes

jobs:
  transaction_alerts:
    runs-on: ubuntu-latest
    steps:
      - name: Get transaction data from BscScan
        env:
          API_KEY: ${{ secrets.BSCSCAN_API_KEY }}
          TOKEN_ADDRESS: '0xAd52f33f9Fc4DE396f2e8236438e9c590680b54b'
          BOT_TOKEN: ${{ secrets.TELEGRAMBOTTOKEN }}
          CHAT_ID: '-1002455751644'
        run: |
          # Fetch the last transactions from the API
          RESPONSE=$(curl -s "https://api.bscscan.com/api?module=account&action=txlist&address=$TOKEN_ADDRESS&startblock=45459378&endblock=latest&sort=desc&apikey=$API_KEY")
          
          # Check if the API response is valid
          if echo "$RESPONSE" | jq -e .status > /dev/null 2>&1 && [ "$(echo "$RESPONSE" | jq -r .status)" = "1" ]; then
            # Extract transaction data
            TX_1_HASH=$(echo "$RESPONSE" | jq -r '.result[0].hash')
            TX_1_TIMESTAMP=$(echo "$RESPONSE" | jq -r '.result[0].timeStamp')
            TX_1_VALUE=$(echo "$RESPONSE" | jq -r '.result[0].value')
            TX_2_HASH=$(echo "$RESPONSE" | jq -r '.result[1].hash')
            TX_2_TIMESTAMP=$(echo "$RESPONSE" | jq -r '.result[1].timeStamp')
            TX_2_VALUE=$(echo "$RESPONSE" | jq -r '.result[1].value')
            
            # Convert transaction value to BNB
            TX_1_AMOUNT=$(echo "scale=4; $TX_1_VALUE / 10^18" | bc)
            TX_2_AMOUNT=$(echo "scale=4; $TX_2_VALUE / 10^18" | bc)
            
            # Format the message
            MESSAGE="üöÄ ElonXCat Transaction Alert üöÄ\n\nüìÖ Date & Time: $(date -d @$TX_1_TIMESTAMP)\nüí∞ Amount: $TX_1_AMOUNT BNB\nüîó Transaction ID: $TX_1_HASH\nüîç [View on BscScan](https://bscscan.com/tx/$TX_1_HASH)\n\nüìÖ Date & Time: $(date -d @$TX_2_TIMESTAMP)\nüí∞ Amount: $TX_2_AMOUNT BNB\nüîó Transaction ID: $TX_2_HASH\nüîç [View on BscScan](https://bscscan.com/tx/$TX_2_HASH)"
            
            # Send the message to Telegram
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -d "chat_id=$CHAT_ID" \
              -d "parse_mode=Markdown" \
              -d "text=$MESSAGE"
          else
            echo "No valid transactions found or an error occurred: $RESPONSE"
          fi
